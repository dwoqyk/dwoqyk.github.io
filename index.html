<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Заявка на занятия</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #0b1220);
      --card: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.12);
      --text: var(--tg-theme-text-color, #fff);
      --shadow: 0 12px 30px rgba(0,0,0,.25);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(58,160,255,.25), transparent 60%),
                  radial-gradient(1000px 600px at 110% 10%, rgba(255,176,32,.18), transparent 60%),
                  var(--bg);
      color: var(--text);
    }
    h1{ margin: 0 0 14px; font-size: 20px; letter-spacing:.2px; }
    .sub{ opacity:.9; font-size:13px; margin-bottom:16px;}
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
    }
    label{display:block; font-size:13px; opacity:.95; margin-bottom:6px;}
    select, input, textarea{
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text); outline:none;
      font-size: 16px; /* Предотвращает зум на iOS */
      -webkit-appearance: none;
    }
    textarea{min-height:100px; resize:vertical;}
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .muted{font-size:12px; opacity:.8; margin-top:6px}
    .hidden{display:none;}
  </style>
</head>
<body>
  <h1>Заявка на занятия</h1>
  <div class="sub">Заполните поля — мы сразу начнём подбор подходящего репетитора.</div>

  <!-- ПРЕДМЕТ -->
  <div class="card">
    <label>Предмет</label>
    <select id="subject" onchange="toggleSubjectCustom()">
      <optgroup label="Языки">
        <option>Английский язык</option>
        <option>Русский язык</option>
        <option>Литература</option>
        <option>Немецкий язык</option>
        <option>Французский язык</option>
        <option>Испанский язык</option>
        <option>Китайский язык</option>
      </optgroup>
      <optgroup label="Точные / IT">
        <option>Математика</option>
        <option>Математика ОГЭ</option>
        <option>Математика ЕГЭ</option>
        <option>Физика</option>
        <option>Химия</option>
        <option>Информатика / программирование</option>
      </optgroup>
      <optgroup label="Естественные / обществознание">
        <option>Биология</option>
        <option>География</option>
        <option>История</option>
        <option>Обществознание</option>
      </optgroup>
      <optgroup label="Школьная подготовка">
        <option>Подготовка к школе</option>
      </optgroup>
      <optgroup label="Другое">
        <option>Написать вручную</option>
      </optgroup>
    </select>
    <input id="subject_custom" class="hidden" type="text" placeholder="Введите предмет (например: Экономика, Логопед)"/>
  </div>

  <!-- КТО УЧЕНИК -->
  <div class="card">
    <label>Кто ученик</label>
    <select id="student" onchange="toggleStudentCustom()">
      <option>Начальная школа</option>
      <option>Средняя школа</option>
      <option>Старшая школа</option>
      <option>Студент</option>
      <option>Подготовка к экзаменам (ОГЭ/ЕГЭ)</option>
      <option>Взрослый</option>
      <option>Написать вручную</option>
    </select>
    <input id="student_custom" class="hidden" type="text" placeholder="Опишите: класс/возраст/статус — как удобно"/>
  </div>

  <!-- БЮДЖЕТ + ЗАНЯТИЙ -->
  <div class="row">
    <div class="card">
      <label>Бюджет</label>
      <select id="rate" onchange="toggleRateCustom()">
        <option>До 700 ₽</option>
        <option>700–1000 ₽</option>
        <option>1000–1500 ₽</option>
        <option>1500–2000 ₽</option>
        <option>2000–3000 ₽</option>
        <option>3000+ ₽</option>
        <option>Укажу сумму вручную</option>
        <option>По договорённости</option>
      </select>
      <input id="rate_custom" class="hidden" type="text" placeholder="Укажите сумму/диапазон (напр.: 1200 ₽ за 60 минут)"/>
      <div class="muted">Если сомневаетесь — оставьте «По договорённости».</div>
    </div>
    <div class="card">
      <label>Занятий в неделю</label>
      <select id="lessons">
        <option>1 раз в неделю</option>
        <option selected>2 раза в неделю</option>
        <option>3 раза в неделю</option>
        <option>По необходимости</option>
      </select>
    </div>
  </div>

  <!-- ПОЖЕЛАНИЯ -->
  <div class="card">
    <label>Пожелания</label>
    <textarea id="comment" placeholder="Онлайн/очный формат, дни недели, упор на грамматику, подготовка к ЕГЭ/ОГЭ"></textarea>
  </div>

  <!-- КОНТАКТ -->
  <div class="card">
    <label>Контакт для связи (необязательно)</label>
    <input id="contact" type="text" placeholder="@username или +71234567890 (можно оставить пустым)"/>
    <div class="muted">Если у вас есть @username, можно оставить поле пустым — бот подставит его автоматически.</div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    const user = tg?.initDataUnsafe?.user;
    if (user?.username) {
      document.getElementById('contact').placeholder = "@" + user.username + " (можно оставить пустым)";
    }

    // Скрытие клавиатуры на iPhone при тапе вне полей ввода
    function hideKeyboard() {
      if (document.activeElement && 
          (document.activeElement.tagName.toLowerCase() === 'input' || 
           document.activeElement.tagName.toLowerCase() === 'textarea')) {
        document.activeElement.blur();
      }
    }

    document.addEventListener('touchstart', function(e) {
      const inputs = ['input', 'textarea', 'select'];
      const isInputTarget = inputs.some(tag => e.target.tagName.toLowerCase() === tag);
      const isInputParent = e.target.closest('input, textarea, select');
      
      if (!isInputTarget && !isInputParent) {
        hideKeyboard();
      }
    }, false);

    // Дополнительная обработка для скрытия клавиатуры при скролле
    let scrollTimer;
    document.addEventListener('touchmove', function() {
      clearTimeout(scrollTimer);
      scrollTimer = setTimeout(hideKeyboard, 150);
    }, { passive: true });

    function toggleSubjectCustom(){
      const sel = document.getElementById('subject');
      const inp = document.getElementById('subject_custom');
      inp.classList.toggle('hidden', sel.value !== 'Написать вручную');
    }
    function toggleStudentCustom(){
      const sel = document.getElementById('student');
      const inp = document.getElementById('student_custom');
      inp.classList.toggle('hidden', sel.value !== 'Написать вручную');
    }
    function toggleRateCustom(){
      const sel = document.getElementById('rate');
      const inp = document.getElementById('rate_custom');
      inp.classList.toggle('hidden', sel.value !== 'Укажу сумму вручную');
    }

    function getForm(){
      const subject = document.getElementById('subject').value;
      const student = document.getElementById('student').value;
      const rate    = document.getElementById('rate').value;

      return {
        subject,
        subject_custom: subject === 'Написать вручную'
          ? (document.getElementById('subject_custom').value || "").trim()
          : "",

        student,
        student_custom: student === 'Написать вручную'
          ? (document.getElementById('student_custom').value || "").trim()
          : "",

        rate,
        rate_custom: rate === 'Укажу сумму вручную'
          ? (document.getElementById('rate_custom').value || "").trim()
          : "",

        lessons: document.getElementById('lessons').value,
        comment: (document.getElementById('comment').value || "").trim(),
        contact: (document.getElementById('contact').value || "").trim(),
      };
    }

    tg?.MainButton.setText("Отправить заявку");
    tg?.MainButton.show();

    tg?.onEvent('mainButtonClicked', () => {
      const data = getForm();

      // проверка обязательных
      const req = ["subject","student","rate","lessons"];
      for (const k of req) {
        if (!data[k] || !String(data[k]).trim()) {
          tg.showAlert("Пожалуйста, заполните все поля.");
          return;
        }
      }
      if (data.subject === 'Написать вручную' && !data.subject_custom) {
        tg.showAlert("Пожалуйста, укажите предмет вручную.");
        return;
      }
      if (data.student === 'Написать вручную' && !data.student_custom) {
        tg.showAlert("Пожалуйста, опишите, кто ученик.");
        return;
      }
      if (data.rate === 'Укажу сумму вручную' && !data.rate_custom) {
        tg.showAlert("Пожалуйста, укажите вашу сумму.");
        return;
      }

      // контакт можно не указывать; если указан — проверим формат
      const phoneRe = /^\+\d{10,15}$/;
      if (data.contact && !(data.contact.startsWith("@") || phoneRe.test(data.contact))) {
        tg.showAlert("Введите @username или телефон в формате +71234567890 (или оставьте поле пустым).");
        return;
      }

      tg.sendData(JSON.stringify(data));
      tg.close();
    });
  </script>
</body>
</html>
