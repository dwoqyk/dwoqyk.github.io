<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Заявка на занятия</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #0b1220);
      --card: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.12);
      --text: var(--tg-theme-text-color, #fff);
      --hint: rgba(255,255,255,.85);
      --brand: #3aa0ff;
      --accent: #ffb020;
      --shadow: 0 12px 30px rgba(0,0,0,.25);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(58,160,255,.25), transparent 60%),
                  radial-gradient(1000px 600px at 110% 10%, rgba(255,176,32,.18), transparent 60%),
                  var(--bg);
      color: var(--text);
    }
    h1{ margin: 0 0 10px; font-size: 20px; letter-spacing:.2px; }
    .sub{ opacity:.9; font-size:13px; margin-bottom:12px;}
    .top-actions{ display:flex; gap:8px; margin-bottom:12px; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px; font-size:13px; border-radius:999px;
      background: rgba(255,255,255,.08); border:1px solid var(--border);
      cursor:pointer; user-select:none;
    }
    .pill:hover{ background: rgba(255,255,255,.12); }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
    }
    label{display:block; font-size:13px; opacity:.95; margin-bottom:6px;}
    select, input, textarea{
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text); outline:none;
    }
    textarea{min-height:100px; resize:vertical;}
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .muted{font-size:12px; color: var(--hint); margin-top:6px}
    .hidden{display:none;}
    /* FAQ */
    details{
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      border-radius:12px; padding:10px 12px; margin-bottom:8px;
    }
    details[open]{ background: rgba(255,255,255,.07); }
    summary{
      list-style:none; cursor:pointer; font-size:14px; font-weight:600; display:flex; align-items:center; gap:8px;
    }
    summary::-webkit-details-marker{ display:none; }
    .faq-icon{ width:18px; height:18px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; background:rgba(58,160,255,.25); }
    .faq-body{ font-size:13px; opacity:.95; margin-top:8px; line-height:1.45; }
    .faq-badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(58,160,255,.18); color:#bfe1ff; font-size:12px; margin-left:6px;}
    .code{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: rgba(255,255,255,.12); padding:1px 6px; border-radius:6px;}
  </style>
</head>
<body>
  <h1>Заявка на занятия</h1>
  <div class="sub">Пара кликов — и мы начнём подбор подходящего репетитора.</div>

  <div class="top-actions">
    <a class="pill" href="#faq" onclick="setTimeout(()=>document.getElementById('faq').open=true, 0)">
      <span>ℹ️</span> <span>Помощь и FAQ</span>
    </a>
  </div>

  <!-- ПРЕДМЕТ -->
  <div class="card">
    <label>Предмет</label>
    <select id="subject" onchange="toggleSubjectCustom()">
      <optgroup label="Языки">
        <option>Английский язык</option>
        <option>Русский язык</option>
        <option>Литература</option>
        <option>Немецкий язык</option>
        <option>Французский язык</option>
        <option>Испанский язык</option>
        <option>Китайский язык</option>
        <option>Итальянский язык</option>
      </optgroup>
      <optgroup label="Точные науки">
        <option>Математика</option>
        <option>Математика ОГЭ</option>
        <option>Математика ЕГЭ</option>
        <option>Физика</option>
        <option>Химия</option>
        <option>Информатика / программирование</option>
      </optgroup>
      <optgroup label="Естественные и общественные">
        <option>Биология</option>
        <option>География</option>
        <option>История</option>
        <option>Обществознание</option>
        <option>Экономика</option>
      </optgroup>
      <optgroup label="Школьная подготовка и прочее">
        <option>Подготовка к школе</option>
        <option>Логопед</option>
      </optgroup>
      <optgroup label="Другое">
        <option>Написать вручную</option>
      </optgroup>
    </select>
    <input id="subject_custom" class="hidden" type="text" placeholder="Введите предмет (например: экономика, логопед и т.д.)" />
    <div class="muted">Не нашли? Выберите «Написать вручную» и укажите предмет сами.</div>
  </div>

  <!-- УЧЕНИК -->
  <div class="card">
    <label>Кто ученик</label>
    <select id="student" onchange="toggleStudentCustom()">
      <option>Начальная школа</option>
      <option>Средняя школа</option>
      <option>Старшая школа</option>
      <option>Студент</option>
      <option>Подготовка к экзаменам (ОГЭ/ЕГЭ)</option>
      <option>Взрослый</option>
      <option>Написать вручную</option>
    </select>
    <input id="student_custom" class="hidden" type="text" placeholder="Опишите: класс/возраст/статус — как удобно" />
    <div class="muted">Можно кратко: «5 класс», «11 класс (профиль)», «взрослый: разговорный английский».</div>
  </div>

  <!-- СТАВКА/БЮДЖЕТ + ЗАНЯТИЙ -->
  <div class="row">
    <div class="card">
      <label>Бюджет</label>
      <select id="rate" onchange="toggleRateCustom()">
        <option>До 700 ₽</option>
        <option>700–1000 ₽</option>
        <option>1000–1500 ₽</option>
        <option>1500–2000 ₽</option>
        <option>2000–3000 ₽</option>
        <option>3000+ ₽</option>
        <option>Укажу сумму вручную</option>
        <option>По договорённости</option>
      </select>
      <input id="rate_custom" class="hidden" type="text" placeholder="Например: 1200 ₽ за 60 минут или 1800 ₽ за 90 минут" />
      <div class="muted">Если сомневаетесь — оставьте «По договорённости». Мы подскажем рынок по вашему запросу.</div>
    </div>

    <div class="card">
      <label>Занятий в неделю</label>
      <select id="lessons">
        <option>1 раз в неделю</option>
        <option selected>2 раза в неделю</option>
        <option>3 раза в неделю</option>
        <option>По необходимости</option>
      </select>
    </div>
  </div>

  <!-- ПОЖЕЛАНИЯ -->
  <div class="card">
    <label>Пожелания</label>
    <textarea id="comment" placeholder="Онлайн/очный формат, дни недели, упор на грамматику, подготовка к ЕГЭ/ОГЭ"></textarea>
    <div class="muted">Можно добавить учебник («Петерсон»), желаемую длительность урока (60/90 мин) и часовой пояс.</div>
  </div>

  <!-- КОНТАКТ -->
  <div class="card">
    <label>Контакт для связи (необязательно)</label>
    <input id="contact" type="text" placeholder="@username или +71234567890 (можно оставить пустым)" />
    <div class="muted">Мы не публикуем ваши контакты в общем чате. Они видны только менеджеру для связи.</div>
  </div>

  <!-- FAQ -->
  <div class="card">
    <details id="faq">
      <summary><span class="faq-icon">ℹ️</span> Подсказки и FAQ</summary>
      <div class="faq-body">
        <p><b>Как быстро со мной свяжутся?</b><br>
        Обычно в течение 1–3 часов в рабочее время. Если запрос пришёл вечером, ответ может быть утром.</p>

        <p><b>Как выбрать бюджет?</b><br>
        Ориентиры по рынку: начальная школа — 700–1200 ₽/час, средние классы — 1000–1500 ₽,
        старшие классы/ЕГЭ — 1500–2500 ₽, языки с носителем — от 2000 ₽. Если не уверены — выберите
        «По договорённости», и мы порекомендуем диапазон под вашу задачу.</p>

        <p><b>Что указать в «Пожеланиях»?</b><br>
        Формат (онлайн/очно), дни/время, длительность (60/90 мин), учебник («Петерсон», «Мерзляк»),
        акцент (грамматика/практика/подготовка к ЕГЭ/ОГЭ), часовой пояс. Пример:
        <span class="code">онлайн, вт/чт 18:00 мск, 60 мин, акцент на грамматику, учебник Петерсон</span>.</p>

        <p><b>Нужен ли @username?</b><br>
        Если у вас есть @username — можно оставить «Контакт» пустым: мы подставим его автоматически.
        Если нет — укажите телефон в формате <span class="code">+7XXXXXXXXXX</span>.</p>

        <p><b>Как поставить @username?</b><br>
        Telegram → <i>Настройки</i> → <i>Изменить профиль</i> → <i>Имя пользователя</i> → введите уникальное имя без «@» → Сохранить.
        После этого контакт можно не указывать — мы увидим ваш username автоматически.</p>

        <p><b>Безопасность контактов</b><br>
        Контактные данные из этой формы видны только менеджеру и не отправляются в общий чат с репетиторами.</p>
      </div>
    </details>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    // Автоплейсхолдер контакта по username
    const user = tg?.initDataUnsafe?.user;
    if (user?.username) {
      document.getElementById('contact').placeholder = "@" + user.username + " (можно оставить пустым)";
    }

    function toggleSubjectCustom(){
      const sel = document.getElementById('subject');
      const inp = document.getElementById('subject_custom');
      inp.classList.toggle('hidden', sel.value !== 'Написать вручную');
    }
    function toggleStudentCustom(){
      const sel = document.getElementById('student');
      const inp = document.getElementById('student_custom');
      inp.classList.toggle('hidden', sel.value !== 'Написать вручную');
    }
    function toggleRateCustom(){
      const sel = document.getElementById('rate');
      const inp = document.getElementById('rate_custom');
      inp.classList.toggle('hidden', sel.value !== 'Укажу сумму вручную');
    }

    function getForm(){
      const subject = document.getElementById('subject').value;
      const student = document.getElementById('student').value;
      const rate    = document.getElementById('rate').value;

      return {
        subject,
        subject_custom: subject === 'Написать вручную'
          ? (document.getElementById('subject_custom').value || "").trim()
          : "",

        student,
        student_custom: student === 'Написать вручную'
          ? (document.getElementById('student_custom').value || "").trim()
          : "",

        rate,
        rate_custom: rate === 'Укажу сумму вручную'
          ? (document.getElementById('rate_custom').value || "").trim()
          : "",

        lessons: document.getElementById('lessons').value,
        comment: (document.getElementById('comment').value || "").trim(),
        contact: (document.getElementById('contact').value || "").trim(),
      };
    }

    // Главная кнопка
    tg?.MainButton.setText("Отправить заявку");
    tg?.MainButton.show();

    tg?.onEvent('mainButtonClicked', () => {
      const data = getForm();

      // базовая валидация
      const req = ["subject","student","rate","lessons"];
      for (const k of req) {
        if (!data[k] || !String(data[k]).trim()) {
          tg.showAlert("Пожалуйста, заполните все поля.");
          return;
        }
      }
      if (data.subject === 'Написать вручную' && !data.subject_custom) {
        tg.showAlert("Пожалуйста, укажите предмет вручную.");
        return;
      }
      if (data.student === 'Написать вручную' && !data.student_custom) {
        tg.showAlert("Пожалуйста, опишите, кто ученик.");
        return;
      }
      if (data.rate === 'Укажу сумму вручную' && !data.rate_custom) {
        tg.showAlert("Пожалуйста, укажите вашу сумму.");
        return;
      }

      const phoneRe = /^\+\d{10,15}$/;
      if (data.contact && !(data.contact.startsWith("@") || phoneRe.test(data.contact))) {
        tg.showAlert("Введите @username или телефон в формате +71234567890 (или оставьте поле пустым).");
        return;
      }

      tg.sendData(JSON.stringify(data));
      tg.close();
    });
  </script>
</body>
</html>
