<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Заявка на репетитора</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-viewport-height: 100vh;
      --tg-viewport-stable-height: 100vh;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: max(16px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right)) max(16px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      min-height: var(--tg-viewport-stable-height, 100vh);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }
    .card {
      background: var(--tg-theme-secondary-bg-color, rgba(0,0,0,0.04));
      border: 1px solid var(--tg-theme-section-separator-color, rgba(0,0,0,0.08));
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: background-color 0.2s ease;
    }
    label { 
      display: block; 
      font-size: 14px; 
      font-weight: 500;
      color: var(--tg-theme-hint-color, rgba(0,0,0,0.6)); 
      margin-bottom: 8px; 
    }
    select, input, textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--tg-theme-section-separator-color, rgba(0,0,0,0.15));
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
    }
    
    select:focus, input:focus, textarea:focus {
      border-color: var(--tg-theme-button-color, #0088cc);
    }
    
    select {
      background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3E%3Cpath fill='%23666' d='m2 0-2 2h4zm0 5 2-2h-4z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
      padding-right: 36px;
    }
    textarea { 
      min-height: 96px; 
      resize: vertical; 
      font-family: inherit;
      line-height: 1.4;
    }
    .row { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 12px; 
    }
    
    @media (max-width: 480px) {
      .row {
        grid-template-columns: 1fr;
        gap: 12px;
      }
    }
    .muted { 
      font-size: 12px; 
      color: var(--tg-theme-hint-color, rgba(0,0,0,0.6)); 
      margin-top: 6px; 
      line-height: 1.3;
    }
    .hint { 
      font-size: 12px; 
      color: var(--tg-theme-hint-color, rgba(0,0,0,0.6)); 
      line-height: 1.3;
    }
    .badge { 
      display: inline-block; 
      padding: 3px 8px; 
      border-radius: 12px; 
      background: var(--tg-theme-button-color, rgba(0,136,204,0.15)); 
      color: var(--tg-theme-button-text-color, #0088cc);
      font-size: 11px; 
      font-weight: 500;
      margin-left: 8px;
    }
    .contact-row { display:grid; grid-template-columns: 1fr; gap: 8px; }
    .note { 
      font-size: 12px; 
      color: var(--tg-theme-hint-color, rgba(0,0,0,0.6)); 
      margin-top: 8px; 
      line-height: 1.3;
    }
  </style>
</head>
<body>
  <h2 style="margin:4px 0 20px; font-size:20px; font-weight:600; color:var(--tg-theme-text-color, #000000);">Заявка на подбор репетитора</h2>

  <div class="card">
    <label>Предмет</label>
    <select id="subject">
      <option value="Английский язык">Английский язык</option>
      <option value="Математика">Математика</option>
      <option value="Русский язык">Русский язык</option>
      <option value="Физика">Физика</option>
      <option value="Химия">Химия</option>
      <option value="Информатика / программирование">Информатика / программирование</option>
      <option value="Другое">Другое</option>
    </select>
  </div>

  <div class="card">
    <label>Кто ученик <span class="badge">возраст/класс</span></label>
    <select id="student">
      <option>7 лет, 2 класс</option>
      <option>10 лет, 4 класс</option>
      <option>14 лет, 8 класс</option>
      <option>11 класс (ЕГЭ)</option>
      <option>Взрослый студент</option>
      <option>Другое</option>
    </select>
  </div>

  <div class="row">
    <div class="card">
      <label>Бюджет</label>
      <select id="rate">
        <option>500–800 руб./занятие</option>
        <option>800–1200 руб./занятие</option>
        <option>1000–1500 руб./занятие</option>
        <option>По договорённости</option>
      </select>
      <div class="muted">Можно выбрать «По договорённости»</div>
    </div>

    <div class="card">
      <label>Занятий в неделю</label>
      <select id="lessons">
        <option>1 раз в неделю</option>
        <option selected>2 раза в неделю</option>
        <option>3 раза в неделю</option>
        <option>По необходимости</option>
      </select>
    </div>
  </div>

  <div class="card">
    <label>Пожелания (формат, время, темы)</label>
    <textarea id="comment" placeholder="Например: онлайн-формат, утро Пн/Ср, упор на грамматику"></textarea>
  </div>

  <div class="card">
    <label>Контакт для связи</label>
    <div class="contact-row">
      <input id="contact" type="text" placeholder="@username или +71234567890" />
      <div class="hint">Если у вас есть @username — можно оставить поле пустым, мы подставим его автоматически.</div>
      <div class="note">Цена за заявку для репетитора — <b>2000 ₽</b>.</div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    
    if (tg) {
      tg.expand();
      tg.ready();
      
      // Применяем тему
      const themeParams = tg.themeParams;
      if (themeParams) {
        const root = document.documentElement;
        Object.entries(themeParams).forEach(([key, value]) => {
          root.style.setProperty(`--tg-theme-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`, value);
        });
      }
      
      // Устанавливаем высоту viewport
      const setViewportHeight = () => {
        const height = tg.viewportHeight || window.innerHeight;
        document.documentElement.style.setProperty('--tg-viewport-height', height + 'px');
        document.documentElement.style.setProperty('--tg-viewport-stable-height', tg.viewportStableHeight || height + 'px');
      };
      
      setViewportHeight();
      tg.onEvent('viewportChanged', setViewportHeight);
    }

    // Попробуем автоподставить username в placeholder контакта
    const user = tg?.initDataUnsafe?.user;
    const contactInput = document.getElementById('contact');
    if (user && user.username) {
      contactInput.placeholder = "@" + user.username + " (оставьте пустым, если он верный)";
    }

    function getForm() {
      return {
        subject:  document.getElementById('subject').value,
        student:  document.getElementById('student').value,
        rate:     document.getElementById('rate').value,
        lessons:  document.getElementById('lessons').value,
        comment:  document.getElementById('comment').value.trim() || "без дополнительных пожеланий",
        contact:  document.getElementById('contact').value.trim(), // может быть пустым: бот сам подставит @username
      };
    }

    // Включаем главную кнопку Telegram
    tg?.MainButton.setText("Отправить заявку");
    tg?.MainButton.show();

    tg?.onEvent('mainButtonClicked', () => {
      const data = getForm();

      // Простейшая проверка обязательных полей
      if (!data.subject || !data.student || !data.rate || !data.lessons) {
        tg.showAlert("Пожалуйста, заполните все поля.");
        return;
      }

      // Если контакт пустой — ок (бот подставит @username). Если не пустой — слегка проверим формат.
      const phoneRe = /^\+\d{10,15}$/;
      if (data.contact && !(data.contact.startsWith("@") || phoneRe.test(data.contact))) {
        tg.showAlert("Введите @username или телефон в формате +71234567890 (или оставьте пустым).");
        return;
      }

      tg.sendData(JSON.stringify(data));
      tg.close();
    });
  </script>
</body>
</html>
